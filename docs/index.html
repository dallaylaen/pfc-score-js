<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Prefrontal cortex score sheet</title>
    <script lang="javascript">
        window.onerror = function(msg) {
            document.getElementById("error").innerHTML += '<div>'+msg+'</div>';
        };
    </script>
    <script lang="javascript" src="js/3rd-party/jquery.js"></script>
    <script lang="javascript" src="js/3rd-party/strftime.js"></script>
    <script lang="javascript" src="js/3rd-party/jrna.js"></script>
    <script lang="javascript" src="js/pfc.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .day {
            border:  solid green 1px;
            padding: 0.25em;
            margin:  0.25em;
        }
    </style>
</head>
<body>
    <div id="error" style="color: red"></div>
    <h1>Prefrontal cortex score sheet</h1>

    <!-- initial node to attach to -->
    <div id="root">
        <div id="summary" align="right">
        </div>
        <div id="editor" align="center">
            <input class="jrna-descr">
            <button class="jrna-send">++</button>
        </div>
    </div>

    <!-- html snippets from .htmlFrom() -->
    <div id="library" style="display: none">
        <div class="day jrna-control" style="display: inline-block">
            <span class="jrna-date"></span>
            <span class="jrna-score"></span>
        </div>
    </div>

    <!-- the script is here -->
    <script lang="javascript" id="main">
        'use strict';

        const sto = window.localStorage;

        console.log(PFC);

        const pfc = new PFC();

        try {
            pfc.load(sto.getItem('pfc'));
        } catch(e) {
            window.onerror("Failed to load pfc data: "+e);
        };

        const showDay = new jRna()
            .htmlFrom('#library .day')
            .click( 'control', function () {
                // TODO
            })
            .output( 'date' )
            .output( 'score' )
            .args( 'day' )
            .def( 'update', function() {
                this.date  = this.day.day;
                this.score = this.day.score();
            })
            .onAttach('update');

        const summary = new jRna()
            .def( 'update', function() {
                const last = pfc.getDays().reverse().slice(0,5).reverse();
                this.container.html('');
                last.forEach(d => showDay.appendTo( 
                    this.container, { day : pfc.getDetails(d) }
                ));
            })
            .onAttach( 'update' )
            .attach($('#summary'));

        const editor = new jRna()
            .input( 'descr' )
            .click( 'send', function() {
                pfc.addRecord({ descr: this.descr });
                this.descr = '';
            })
            .attach($('#editor'));

        pfc.onUpdate(function(r,d,p){
            sto.setItem('pfc', JSON.stringify(pfc.save()));
            summary.update();
        });
    </script>

    <!-- describe how to use the page, if needed -->
    <div id="usage">
    </div>
</body>
</html>
